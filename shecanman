#!/bin/bash

# Author: Amir Rezazadeh (@amirz98)
# Project: ShecanMan (https://github.com/amirz98/shecanman)
#
# If you have found any issue or have some feature request:
# Please raise them here: https://github.com/amirz98/shecanman/issues

VRESION="0.1.1"

SHECAN_DNS="# Shecan dns server
nameserver 178.22.122.100
nameserver 185.51.200.2"

function show_usage() {
  echo -e "
╭━━━┳╮╱╱╱╱╱╱╱╱╱╱╱╱╱╭━╮╭━╮
┃╭━╮┃┃╱╱╱╱╱╱╱╱╱╱╱╱╱┃┃╰╯┃┃
┃╰━━┫╰━┳━━┳━━┳━━┳━╮┃╭╮╭╮┣━━┳━╮
╰━━╮┃╭╮┃┃━┫╭━┫╭╮┃╭╮┫┃┃┃┃┃╭╮┃╭╮╮
┃╰━╯┃┃┃┃┃━┫╰━┫╭╮┃┃┃┃┃┃┃┃┃╭╮┃┃┃┃
╰━━━┻╯╰┻━━┻━━┻╯╰┻╯╰┻╯╰╯╰┻╯╰┻╯╰╯

shecanman lets you switch on/off Shecan.ir DNS configs temporarily on linux.

Usage: shecanman [command]

Commands:
on      \t  Switch on Shecan.ir DNS configs
off     \t  Switch off Shecan.ir DNS configs; This will restore previous DNS configs
status  \t  Show current status
install \t  Install shecanman system-wide, so you can call it from everywhere
uninstall \t  Uninstall shecanman, so that shecanman is longer available system-wide
version \t  Show shecanman version
help    \t  Show this help"
}

function exit_if_not_root() {
  if [[ $EUID -ne 0 ]]; then
    echo "Permission denied. Please run as root."
    exit 1
  fi
}

function is_shecan_on() {
  if [[ $(</etc/resolv.conf) != "$SHECAN_DNS" ]]; then
    return 1
  else
    return 0
  fi
}

function switch_on() {
  if is_shecan_on; then
    echo "Shecan is already in use."
  else
    exit_if_not_root
    cp /etc/resolv.conf /etc/resolv.conf.backup
    echo "$SHECAN_DNS" >/etc/resolv.conf
    echo "Shecan DNS switched on."
  fi
}

function switch_off() {
  if ! is_shecan_on; then
    echo "Shecan is not in use."
  else
    exit_if_not_root
    cp /etc/resolv.conf.backup /etc/resolv.conf
    rm /etc/resolv.conf.backup
    echo "Shecan DNS switched off."
  fi
}

function show_status() {
  if is_shecan_on; then
    echo "Shecan is in use."
  else
    echo "Shecan is not in use."
  fi
}

function install() {
  exit_if_not_root
  chmod +x shecanman
  mkdir -p /usr/local/bin
  cp shecanman /usr/local/bin/
  echo "Congratulations! shecanman now is accessible everywhere."
  if ! is_shecan_on; then
    echo "Use [shecanman on] to switch on Shecan.ir DNS configs."
  fi
}

function uninstall() {
  exit_if_not_root
  if is_shecan_on; then
    switch_off
  fi

  if [ -f /usr/local/bin/shecanman ]; then
    rm /usr/local/bin/shecanman
  fi
  echo "shecanman uninstalled successfully."
}

function show_version() {
  echo "ShecanMan v$VRESION"
}

function main() {
  case "$1" in
  "on") switch_on ;;
  "off") switch_off ;;
  "status") show_status ;;
  "install") install ;;
  "uninstall") uninstall ;;
  "version") show_version ;;
  *) show_usage ;;
  esac
}

main "$@"
