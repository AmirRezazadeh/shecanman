#!/bin/bash

# Author: Amir Rezazadeh (@amirz98)
# Project: ShecanMan (https://github.com/amirz98/shecanman)
#
# If you have found any issue or have some feature request:
# Please raise them here: https://github.com/amirz98/shecanman/issues

VRESION="0.2.0"

SHECAN_DNS="# Shecan dns server
nameserver 178.22.122.100
nameserver 185.51.200.2"

# check if stdout is a terminal
if test -t 1; then
  # see if it supports colors
  ncolors=$(tput colors)

  if test -n "$ncolors" && test $ncolors -ge 8; then
    bold="$(tput bold)"
    normal="$(tput sgr0)"
    red="$(tput setaf 1)"
    green="$(tput setaf 2)"
  fi
fi

function show_usage() {
  echo -e "
╭━━━┳╮╱╱╱╱╱╱╱╱╱╱╱╱╱╭━╮╭━╮
┃╭━╮┃┃╱╱╱╱╱╱╱╱╱╱╱╱╱┃┃╰╯┃┃
┃╰━━┫╰━┳━━┳━━┳━━┳━╮┃╭╮╭╮┣━━┳━╮
╰━━╮┃╭╮┃┃━┫╭━┫╭╮┃╭╮┫┃┃┃┃┃╭╮┃╭╮╮
┃╰━╯┃┃┃┃┃━┫╰━┫╭╮┃┃┃┃┃┃┃┃┃╭╮┃┃┃┃
╰━━━┻╯╰┻━━┻━━┻╯╰┻╯╰┻╯╰╯╰┻╯╰┻╯╰╯

ShecanMan lets you switch on/off Shecan.ir DNS configs temporarily on linux.

Usage: ${bold}shecanman [${green}command${normal}]

Commands:
${bold}${green} on      \t${normal}Switch on Shecan DNS configs; keeps a backup of current configs
${bold}${green} off     \t${normal}Switch off Shecan DNS; This will restore previous DNS configs
${bold}${green} status  \t${normal}Show current status; Check whether ShecanMan is on
${bold}${green} install \t${normal}Install ShecanMan system-wide, so you can call it everywhere
${bold}${green} uninstall \t${normal}Uninstall ShecanMan, so it's no longer accessible system-wide
${bold}${green} version \t${normal}Show ShecanMan version
${bold}${green} help    \t${normal}Show this help"
}

function exit_if_not_root() {
  if [[ $EUID -ne 0 ]]; then
    echo "${bold}${red} Permission denied. Please run as root.${normal}"
    exit 1
  fi
}

function is_shecan_on() {
  if [[ $(</etc/resolv.conf) != "$SHECAN_DNS" ]]; then
    return 1
  else
    return 0
  fi
}

function switch_on() {
  if is_shecan_on; then
    echo "${bold}${green} Shecan is already in use.${normal}"
  else
    exit_if_not_root
    cp /etc/resolv.conf /etc/resolv.conf.backup
    echo "$SHECAN_DNS" >/etc/resolv.conf
    echo "${bold}${green} Shecan DNS switched on.${normal}"
  fi
}

function switch_off() {
  if ! is_shecan_on; then
    echo "${bold}${green} Shecan is not in use.${normal}"
  else
    exit_if_not_root
    cp /etc/resolv.conf.backup /etc/resolv.conf
    rm /etc/resolv.conf.backup
    echo "${bold}${green} Shecan DNS switched off.${normal}"
  fi
}

function show_status() {
  if is_shecan_on; then
    echo "${bold}${green} Shecan is in use.${normal}"
  else
    echo "${bold}${green} Shecan is not in use.${normal}"
  fi
}

function install() {
  exit_if_not_root
  chmod +x shecanman
  mkdir -p /usr/local/bin
  cp shecanman /usr/local/bin/
  echo "${bold}${green} Congratulations! shecanman now is accessible everywhere.${normal}"
  if ! is_shecan_on; then
    echo "${bold}${green} Use [shecanman on] to switch on Shecan.ir DNS configs.${normal}"
  fi
}

function uninstall() {
  exit_if_not_root
  if is_shecan_on; then
    switch_off
  fi

  if [ -f /usr/local/bin/shecanman ]; then
    rm /usr/local/bin/shecanman
  fi
  echo "${bold}${green} shecanman uninstalled successfully.${normal}"
}

function show_version() {
  echo "${bold}${green} ShecanMan v$VRESION ${normal}"
}

function main() {
  case "$1" in
  "on") switch_on ;;
  "off") switch_off ;;
  "status") show_status ;;
  "install") install ;;
  "uninstall") uninstall ;;
  "version") show_version ;;
  *) show_usage ;;
  esac
}

main "$@"
